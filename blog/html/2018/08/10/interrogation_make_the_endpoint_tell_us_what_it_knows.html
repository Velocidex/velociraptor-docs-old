<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Velociraptor is a Digital Forensic and Incident Response tool.">
        <meta name="viewport" content="width=device-width">
        <title>Interrogation - Make the endpoint tell us what it knows! &mdash; Velociraptor</title>
            <link rel="stylesheet" href="../../../_static/normalize.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/sphinx.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/main.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/dark.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="../../../_static/font-awesome.min.css" type="text/css">
        <link rel="stylesheet" href="../../../_static/velo.css" type="text/css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.1/jquery.fancybox.min.css" type="text/css" /><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" type="text/css" /><link rel="shortcut icon" href="../../../_static/favicon.png" /><!-- Load modernizr and JQuery -->
<script src="../../../_static/vendor/modernizr-2.6.2.min.js"></script>
<script src="//code.jquery.com/jquery-1.12.4.min.js"></script>
<script>window.jQuery || document.write('<script src="../../../_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
<script src="../../../_static/plugins.js"></script>
<script src="../../../_static/main.js"></script>
<link rel="search" title="Search" href="../../../search.html" /><link rel="next" title="Design differences between Velociraptor and GRR" href="design_differences_between_velociraptor_and_grr.html" /><link rel="prev" title="Hunting - What Velociraptors do best!" href="hunting_what_velociraptors_do_best.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.7.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="../../../_static/underscore.js"></script><script type="text/javascript" src="../../../_static/doctools.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script><script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/javascript" src="../../../_static/disqus.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            // Adjusts document height if sidebar is taller
            var documentwrapper = document.getElementsByTagName('article')[0];
            var sidebar = document.getElementsByTagName('aside')[0];

            if (sidebar.offsetHeight > documentwrapper.offsetHeight)
            {
                documentwrapper.style.minHeight = sidebar.offsetHeight + "px";
            }

            // Scroll to content if on small screen
            if (screen.width < 480)
            {
                $(document).scrollTop(documentwrapper.offsetTop - 44);
            }
        });
    </script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><div class="header-container">
  <header class="wrapper clearfix" role="banner">
    <div class="title">
      <h1><a href="../../../index.html">Velociraptor</a></h1>
      <h4>Hunting for evil - what Velociraptors do best!</h4>
    </div>
    <div class="logo">
      <img src="../../../_static/velo.png"
           alt="Log" class="logo"/>

    </div>
    <nav class="big_nav" role="navigation">
      <ul>
        <li class="main-nav">
          <a href="../../../pages/overview.html">Overview</a>
        </li>

        <li class="main-nav">
          <a href="../../../reference/artifacts.html">Artifacts</a>
        </li><li class="quicklink"><div class="rss">
        <a href="../../../rss.html" title="Subscribe via RSS"><span class="fa fa-lg fa-rss"></span></a>
    </div></li><li class="main-nav">
            <a href="https://github.com/Velocidex/velociraptor">
              <span class="fa fa-lg fa-github"></span>
            </a>
        </li>
      </ul>
    </nav>
  </header>
</div>

<div class="main-container" role="main"><div class="main wrapper body clearfix"><article role="article"><ul class="related clearfix">
            <li class="left"> &laquo; <a href="hunting_what_velociraptors_do_best.html">Hunting - What Velociraptors do best!</a></li>
            <li class="right"><a href="design_differences_between_velociraptor_and_grr.html">Design differences between Velociraptor and GRR</a> &raquo; </li>
        </ul>
  
     <div class="section" id="interrogation-make-the-endpoint-tell-us-what-it-knows">
<h1>Interrogation - Make the endpoint tell us what it knows!</h1>
<p>Interrogation is the process of learning general information about the
endpoint we are monitoring. Each endpoint is automatically
interrogated when it first joins the Velociraptor server, and the GUI
shows this general information about each client.</p>
<p>When writing Velociraptor we decided to keep things very simple - we
did away with a lot of the information gathered during interrogate in
favor of a much simpler data model.</p>
<div id="more"> </div><div class="section" id="data-modelling-the-interrogate-flow">
<h2>Data Modelling - The Interrogate Flow</h2>
<p>GRR maintains an elaborate model of client data. For example, GRR
collects and maintains a list of clients’ network interfaces, users,
user’s home directory etc. This information is maintained in elaborate
protobufs and stored in the database in many rows.</p>
<p>While some of this information is needed for client searching, GRR
maintains vastly more information than necessary in this data
model. The client data model is built during the interrogate phase (A
periodic flow run on the clients to refresh server side data).</p>
<p>Maintaining such a complex data model results in a very rigid
design. For example, if a user wanted to collect more information from
clients they would need to modify protobufs, update the interrogate
flow, recompile the code and redeploy. These modifications are also
very invasive as once code has been heavily modified, there is an
overhead of keeping these modifications in sync with newer upstream
versions.</p>
<p>Velociraptor also maintains client information via its Interrogate
flow. However, Velociraptor’s interrogate flow simply issues a series
of VQL queries, and these responses are stored directly in the
database with minimal interpretation. Indexes are maintained for some
information which users should be able to search on, but there is no
attempt to build or maintain a client data model at all (You can see
details of the model described below in the FileBaseDataStore post).</p>
<p>The advantage of this approach is that users can simply add extra VQL
queries to the interrogate phase to collect more tailored site
specific information. This does not require compiling of any code or
redeploying the server. The following example illustrates the power of
this technique.</p>
</div>
<div class="section" id="customizing-the-interrogate-flow">
<h2>Customizing the Interrogate flow.</h2>
<p>Normally Velociraptor collects minimal information from the client
upon interrogation (i.e. when the client first enrols or when
interrogated periodically). However it is very easy to customize this
collection depending on local site requirements. In this section we
work through a step by step example of extending the Velociraptor
interrogate flow.</p>
<p>Suppose that in our deployment we wanted to check if a machine is able
to be logged into remotely. For a Linux machine we want to see all
authorized_keys files on every machine that enrolls. Collecting this
information allows us to quickly see which machines a compromised user
account could spread to.</p>
<p>We know we need to issue a VQL query but we are not 100% sure which
one. Luckily we can use Velociraptor itself to run the query locally
using the syntax “velociraptor query &lt;query&gt;”.</p>
<p>Start with a simple glob query to find all authorized_keys files:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">FullPath</span> <span class="k">from</span> <span class="n">glob</span><span class="p">(</span><span class="n">globs</span><span class="o">=</span><span class="ss">&quot;/home/*/.ssh/authorized_keys&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Suppose we now want to actually grab a copy of all files so we can
archive them on the server This will keep a record of the authorized
keys on the server for each Interrogate flow. If we run the flow
periodically we will end up with a time based evolution of the
authorized keys files on each host. Pretty handy!</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">FullPath</span><span class="p">,</span>
   <span class="k">timestamp</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="n">Sys</span><span class="p">.</span><span class="n">Mtim</span><span class="p">.</span><span class="n">Sec</span><span class="p">)</span> <span class="k">as</span> <span class="n">Mtime</span><span class="p">,</span>
   <span class="n">upload</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">FullPath</span><span class="p">)</span> <span class="k">as</span> <span class="n">Upload</span>
<span class="k">FROM</span> <span class="n">glob</span><span class="p">(</span><span class="n">globs</span><span class="o">=</span><span class="ss">&quot;/home/*/.ssh/authorized_keys&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can run the query locally using the Velociraptor tool:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mic@localhost:/tmp&gt; velociraptor query <span class="s2">&quot;select FullPath, \</span>
<span class="s2">   timestamp(epoch=Sys.Mtim.Sec) as Mtime, \</span>
<span class="s2">   upload(file=FullPath) as Upload \</span>
<span class="s2">   FROM glob(globs=[&#39;/home/*/.ssh/authorized_keys&#39;])&quot;</span>

velociraptor: Uploaded home/mic/.ssh/authorized_keys <span class="o">(</span><span class="m">395</span> bytes<span class="o">)</span>
<span class="o">[</span>
 <span class="o">{</span>
  <span class="s2">&quot;FullPath&quot;</span>: <span class="s2">&quot;/home/mic/.ssh/authorized_keys&quot;</span>,
  <span class="s2">&quot;Mtime&quot;</span>: <span class="s2">&quot;2018-08-03T18:20:19+10:00&quot;</span>,
  <span class="s2">&quot;Upload&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;Path&quot;</span>: <span class="s2">&quot;home/mic/.ssh/authorized_keys&quot;</span>,
    <span class="s2">&quot;Size&quot;</span>: <span class="m">395</span>
 <span class="o">}</span>
<span class="o">}</span>
<span class="o">]</span>
</pre></div>
</div>
<p>Velociraptor’s query command enables us to run the query directly on
the local host and observe the results. When the same query is issued
to the Velociraptor client, the same result will be generated and sent
to the server. This enables us to interactively develop and test our
queries without needing to run a full client/server.</p>
<p>Note the upload() VQL function which causes the file to be uploaded to
the server. (When run locally the file will be copied to the upload
directory as can be seen by the upload confirmation message), but when
run within the Velociraptor client, the file will be uploaded to the
server and stored within the flow.</p>
<p>We can now add the query to all Interrogate flows that will be run
from now on. We simply add it to the configuration file under the
Interrogate.additional_queries key:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">Interrogate.additional_queries</span><span class="p p-Indicator">:</span>
 <span class="l l-Scalar l-Scalar-Plain">Query</span><span class="p p-Indicator">:</span>
   <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Authorized Keys</span>
     <span class="l l-Scalar l-Scalar-Plain">VQL</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">&gt;</span>
       <span class="no">select FullPath, timestamp(epoch=Mtime.Sec) as Mtime,</span>
       <span class="no">upload(file=FullPath) as Upload</span>
       <span class="no">from glob(globs=&#39;/home/*/.ssh/authorized_keys&#39;)</span>
</pre></div>
</div>
<p>From now on the additional query will be recorded for all clients. The
GUI shows it in the client information page:</p>
<img alt="../../../_images/image6.png" src="../../../_images/image6.png" />
</div>
</div>

  

<div id="disqus_thread"></div><script type="text/javascript">    var disqus_shortname = "velocidex-velociraptor";    var disqus_identifier = "2018/08/10/interrogation_make_the_endpoint_tell_us_what_it_knows";    disqus_thread();</script><noscript>Please enable JavaScript to view the    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<ul class="related clearfix">
            <li class="left"> &laquo; <a href="hunting_what_velociraptors_do_best.html">Hunting - What Velociraptors do best!</a></li>
            <li class="right"><a href="design_differences_between_velociraptor_and_grr.html">Design differences between Velociraptor and GRR</a> &raquo; </li>
        </ul></article><aside class="sidebar"><section><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.1/jquery.fancybox.js"></script>

<script>
  $(document).ready(function() {
    $.each($(".section img"), function() {
       var a = $("<a class='img'>").attr('href', $(this).attr('src'));
       $(this).wrap(a);
    });

    $('.section a.img').fancybox({
       closeExisting: true,
       loop: true,
       arrows: true,
    });
});
</script></section><section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

  <div class='toc sidebar'>
    <ul>
<li><a class="reference internal" href="#">Interrogation - Make the endpoint tell us what it knows!</a><ul>
<li><a class="reference internal" href="#data-modelling-the-interrogate-flow">Data Modelling - The Interrogate Flow</a></li>
<li><a class="reference internal" href="#customizing-the-interrogate-flow">Customizing the Interrogate flow.</a></li>
</ul>
</li>
</ul>

  </div>


  <script>
    var cumulativeOffset = function(element) {
      var top = 0, left = 0;
      do {
       top += element.offsetTop  || 0;
       left += element.offsetLeft || 0;
       element = element.offsetParent;
      } while(element);

      return {
        top: top,
        left: left
      };
    };

  $(window).scroll(function() {
    var scroll = document.documentElement.scrollTop;

  if (scroll > 150) {
      var item = $("aside");
      var offset = cumulativeOffset(item[0]);

      // If the scrollbar overlaps the article do not obscure it.
      if (offset.left < $("article").width()) {
          return;
      };

      item.addClass("fixed");

      if (offset) {
        item.offset({
          left: offset.left
      });
     };
    } else {
      $("aside").removeClass("fixed");
    }
  });

  $(".toc ul").addClass('list-unstyled components');
  $(".toc ul li a").addClass('nav-link nav-item');
</script></section></aside></div> <!-- #main --></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo"><footer class="wrapper">&copy; Copyright 2018 Velocidex Innovations. Powered by <a href="http://www.tinkerer.me/">Tinkerer</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.</footer></div> <!-- footer-container -->

      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>